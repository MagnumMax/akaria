<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKARIA Portal - Интерактивный прототип v5</title>

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
    <script src="data.js"></script>
    <script src="data/contacts.js"></script>
    <script src="data/deals.js"></script>
    <script src="data/properties.js"></script>
    <script src="data/icons.js"></script>
    <script src="data/tasks.js"></script>
    <script src="data/assistant.js"></script>
    <!-- Debug scripts - only for development -->
    <script>
        // Загружаем отладочные скрипты только в режиме разработки
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname.includes('dev')) {
            const debugScripts = ['console-logger.js', 'debug-contacts.js'];
            debugScripts.forEach(script => {
                const scriptElement = document.createElement('script');
                scriptElement.src = script;
                document.head.appendChild(scriptElement);
            });
        }
    </script>
    <script src="fix-contacts-loading.js"></script>
</head>
<body class="bg-white">

    <div id="app-container" class="flex h-screen">
        
        <!-- Sidebar Navigation -->
        <nav id="sidebar" class="hidden md:flex flex-col w-64 flex-shrink-0 border-r border-border bg-muted/40 transition-transform duration-300">
            <div class="flex items-center h-16 px-6 border-b border-border">
                <a href="#dashboard" class="flex items-center gap-2 font-semibold text-lg">
                    <svg class="h-6 w-6 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3L2 9l10 6 10-6-10-6z"/><path d="M2 9l10 6 10-6"/><path d="M2 15l10 6 10-6"/></svg>`,
                    <span>AKARIA Portal</span>
                </a>
            </div>
            <div id="sidebar-nav-links" class="flex-1 overflow-y-auto py-4"></div>
        </nav>

        <!-- Main Content Area -->
        <div class="flex flex-col flex-1">
            <header class="flex items-center h-16 px-4 md:px-6 border-b border-border bg-white sticky top-0 z-20">
                <button class="md:hidden mr-4 p-2 text-gray-600 hover:text-gray-800" id="mobile-menu-btn">
                    <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
                <div class="flex-1"><h1 id="page-title" class="text-xl font-semibold">Dashboard</h1></div>
                <div class="flex items-center gap-4">
                    <button class="p-2 transition-colors text-gray-600 hover:text-gray-800" title="Открыть чат с ассистентом" id="assistant-chat-btn">
                        <svg class="h-5 w-5 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            <path d="M8 10h.01M12 10h.01M16 10h.01"/>
                        </svg>
                    </button>
                    <div class="relative">
                        <button class="flex items-center gap-2 text-gray-600 hover:text-gray-800" id="user-menu-btn">
                            <img src="https://i.pravatar.cc/150?u=ceo" id="user-avatar" class="h-8 w-8 rounded-full" alt="User Avatar">
                            <div class="hidden md:block text-left">
                                <p id="user-name" class="text-sm font-medium">Elena Petrova</p>
                                <p id="user-role-display" class="text-xs text-muted-foreground">CEO</p>
                            </div>
                        </button>
                    </div>
                </div>
            </header>

            <main id="main-content" class="flex-1 overflow-y-auto bg-muted/40">
                <div id="page-content-wrapper" class="p-4 md:p-6">
                    <section id="page-dashboard" class="page-hidden"></section>

                    <section id="page-deals" class="page-hidden"></section>
                    <section id="page-deal-details" class="page-hidden"></section>
                    <section id="page-properties" class="page-hidden"></section>
                    <section id="page-property-details" class="page-hidden"></section>
                    <section id="page-tasks" class="page-hidden"></section>
                    <section id="page-analytics" class="page-hidden"></section>
                    <section id="page-settings" class="page-hidden"></section>
                    <section id="page-imports" class="page-hidden"></section>
                    <section id="page-my-assistant" class="page-hidden"></section>
                    <section id="page-my-assistant-settings" class="page-hidden"></section>
        <section id="page-leads" class="page-hidden"></section>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Floating Role Switcher -->
    <div id="role-switcher" class="fixed bottom-4 right-4 bg-white border border-border shadow-lg rounded-lg p-2 flex flex-col gap-2 z-50">
        <button class="role-btn text-xs px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-role="CEO">CEO</button>
        <button class="role-btn text-xs px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-role="Agent">Agent</button>
        <button class="role-btn text-xs px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-role="Admin">Admin</button>
    </div>
    
    <!-- Mini-Landing Page Offer (Separate view) -->
    <div id="page-offer" class="page-hidden fixed inset-0 bg-white z-[100] overflow-y-auto"></div>
    
    <!-- Modal Container -->
    <div id="modal-container" data-state="closed" class="fixed inset-0 bg-black/60 z-[100] items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b"><h3 id="modal-title" class="font-semibold">Modal Title</h3><button class="p-1 rounded-full hover:bg-gray-100 text-gray-600 hover:text-gray-800" id="modal-close-btn">&times;</button></div>
                <div id="modal-body" class="p-6 overflow-y-auto"></div>
            </div>
    </div>


<script>
// ===================================================================================
// SCRIPT: AKARIA Portal Interactive Prototype
// ===================================================================================

document.addEventListener('DOMContentLoaded', () => {

    // -----------------------------------------------------------------------------
    // 1. STATE MANAGEMENT
    // -----------------------------------------------------------------------------

    let state = { currentUserRole: 'CEO', currentPage: 'dashboard', unassignedLeads: 5 };

    // -----------------------------------------------------------------------------
    // 2. NAVIGATION & ROUTING
    // -----------------------------------------------------------------------------


    
    // Данные загружаются из отдельных модулей через data-loader.js
    
    const ICONS = {
        dashboard: `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3L2 9l10 6 10-6-10-6z"/><path d="M2 9l10 6 10-6"/><path d="M2 15l10 6 10-6"/></svg>`,
        assistant: `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8V4H8"/><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M2 14h2m16 0h2M15 2v2M9 2v2"/></svg>`,
        deals: `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/></svg>`,
        properties: `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 21h12v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2z"/><path d="M14 10a4 4 0 0 1 4-4h2a2 2 0 0 1 2 2v2a4 4 0 0 1-4 4h-2a2 2 0 0 1-2-2v-2zM8 9V7a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/><line x1="12" y1="13" x2="12" y2="15"/></svg>`,
        tasks: `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="m9 14 2 2 4-4"/></svg>`,
        analytics: `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>`,
        settings: `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`,
        imports: `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`,
        contacts: `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
        bot: `<span class="text-lg">✨</span>`,
        anomaly: `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>`,
        chevron: `<svg class="h-4 w-4 transition-transform" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`
    };
    












    // -----------------------------------------------------------------------------
    // 2. NAVIGATION & ROUTING
    // -----------------------------------------------------------------------------
    
    const navLinks = {
        CEO: [ { id: 'dashboard', name: 'Dashboard', icon: ICONS.dashboard }, { id: 'leads', name: 'Leads', icon: ICONS.contacts }, { id: 'deals', name: 'Deals', icon: ICONS.deals }, { id: 'properties', name: 'Properties', icon: ICONS.properties }, { id: 'tasks', name: 'Tasks', icon: ICONS.tasks }, { id: 'analytics', name: 'Analytics', icon: ICONS.analytics }, { id: 'settings', name: 'Settings', icon: ICONS.settings }, { type: 'divider' }, { id: 'my-assistant', name: 'My Assistant', icon: ICONS.assistant }],
        Agent: [ { id: 'dashboard', name: 'Dashboard', icon: ICONS.dashboard }, { id: 'leads', name: 'Leads', icon: ICONS.contacts }, { id: 'tasks', name: 'My Tasks', icon: ICONS.tasks }, { id: 'deals', name: 'My Deals', icon: ICONS.deals }, { id: 'properties', name: 'Properties', icon: ICONS.properties }, { type: 'divider' }, { id: 'my-assistant', name: 'My Assistant', icon: ICONS.assistant }],
        Admin: [ { id: 'dashboard', name: 'Dashboard', icon: ICONS.dashboard }, { id: 'leads', name: 'Manage Leads', icon: ICONS.contacts }, { id: 'imports', name: 'Imports', icon: ICONS.imports }, { id: 'properties', name: 'Manage Properties', icon: ICONS.properties }, { id: 'settings', name: 'Settings', icon: ICONS.settings }]
    };

    function renderSidebar() {
        const links = navLinks[state.currentUserRole];
        const navContainer = document.getElementById('sidebar-nav-links');
        navContainer.innerHTML = `<nav class="grid items-start px-4 text-sm font-medium">${links.map(link => { if (link.type === 'divider') return '<hr class="my-2 border-border">'; const isAssistantLink = link.id === 'jessica' || link.id === 'leonardo'; const linkClasses = `nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:text-foreground ${isAssistantLink ? 'text-accent font-semibold' : ''}`; return `<a href="#${link.id}" data-page="${link.id}" class="${linkClasses}">${link.icon}<span>${link.name}</span></a>`; }).join('')}</nav>`;
        updateActiveNavLink();
    }

    function updateActiveNavLink() {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('nav-active');
            if (link.dataset.page === state.currentPage.split('-')[0]) {
                link.classList.add('nav-active');
            }
        });
    }

    function showPage(pageId, contextId = null) {
        document.querySelectorAll('#page-content-wrapper > section').forEach(page => page.classList.add('page-hidden'));
        
        const targetPage = document.getElementById(`page-${pageId}`);
        if (targetPage) {
            targetPage.classList.remove('page-hidden');
            state.currentPage = pageId;
            
            const renderMap = { 'dashboard': renderDashboard, 'my-assistant': renderMyAssistantPage, 'my-assistant-settings': renderMyAssistantSettingsPage, 'deals': renderDealsPage, 'deal-details': () => renderDealDetailsPage(contextId), 'leads': renderLeadsPage, 'properties': renderPropertiesPage, 'property-details': () => renderPropertyDetailsPage(contextId), 'tasks': renderTasksPage, 'analytics': renderAnalyticsPage, 'settings': renderSettingsPage, 'imports': renderImportsPage };
            if (renderMap[pageId]) renderMap[pageId]();

            const pageConfig = (navLinks[state.currentUserRole] || []).find(p => p.id === pageId);
            document.getElementById('page-title').textContent = pageConfig ? pageConfig.name : pageId.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());

            updateActiveNavLink();
        } else {
            showPage('dashboard');
        }
        document.getElementById('sidebar').classList.add('hidden');
    }

    function handleRouting() {
        let hash = window.location.hash.substring(1);
        if (hash.startsWith('offer/')) {
            const token = hash.split('/')[1];
            renderOfferPage(token);
            document.getElementById('page-offer').classList.remove('page-hidden');
            document.getElementById('app-container').classList.add('page-hidden');
            document.getElementById('role-switcher').classList.add('page-hidden');
            return;
        } else {
            document.getElementById('page-offer').classList.add('page-hidden');
            document.getElementById('app-container').classList.remove('page-hidden');
            document.getElementById('role-switcher').classList.remove('page-hidden');
        }
        const [pageId, contextId] = hash.split('/');
        showPage(pageId || 'dashboard', contextId ? parseInt(contextId) : null);
    }

    // -----------------------------------------------------------------------------
    // 3. PAGE RENDERING FUNCTIONS
    // -----------------------------------------------------------------------------

    function renderDashboard() {
        const page = document.getElementById('page-dashboard');
        const role = state.currentUserRole;
        if (role === 'CEO') renderCeoDashboard(page);
        else if (role === 'Agent') renderAgentDashboard(page);
        else if (role === 'Admin') renderAdminDashboard(page);
    }
    
    function renderAdminDashboard(page) {
        page.innerHTML = `
        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-4">
            <div class="bg-white border rounded-lg p-4"><h3 class="text-sm font-medium text-muted-foreground">System Status</h3><p class="text-2xl font-bold mt-4 text-green-600">All Systems Operational</p></div>
            <div class="bg-white border rounded-lg p-4"><h3 class="text-sm font-medium text-muted-foreground">Active Users</h3><p class="text-2xl font-bold mt-4">${Object.keys(users).length}</p></div>
            <div class="bg-white border rounded-lg p-4"><h3 class="text-sm font-medium text-muted-foreground">Inactive Users</h3><p class="text-2xl font-bold mt-4">${inactiveUsers.length}</p></div>
            <div class="bg-white border rounded-lg p-4"><h3 class="text-sm font-medium text-muted-foreground">System Errors (24h)</h3><p class="text-2xl font-bold mt-4">${systemErrors.length}</p></div>
        </div>
        <div class="mt-6 bg-white border rounded-lg">
            <div class="p-4 border-b"><h3 class="font-semibold">AI Assistant Overview</h3></div>
            <div class="overflow-x-auto"><table class="w-full text-sm">
                <thead><tr class="text-left text-muted-foreground"><th class="p-4">Assistant</th><th class="p-4">Owner</th><th class="p-4">Dialogs Today</th><th class="p-4">Conversion</th></tr></thead>
                <tbody>${assistantStats.map(s => `<tr class="border-t"><td class="p-4 font-medium">${s.assistant}</td><td class="p-4">${s.owner}</td><td class="p-4">${s.dialogs}</td><td class="p-4">${s.conversion}</td></tr>`).join('')}</tbody>
            </table></div>
        </div>
        <div class="mt-6 bg-white border rounded-lg">
            <div class="p-4 border-b"><h3 class="font-semibold">Recent System Errors</h3></div>
            <div class="overflow-x-auto"><table class="w-full text-sm">
                <thead><tr class="text-left text-muted-foreground"><th class="p-4">Time</th><th class="p-4">Code</th><th class="p-4">Message</th></tr></thead>
                <tbody>${systemErrors.map(e => `<tr class="border-t"><td class="p-4 text-red-600">${e.time}</td><td class="p-4 font-mono">${e.code}</td><td class="p-4">${e.message}</td></tr>`).join('')}</tbody>
            </table></div>
        </div>`;
    }

    function renderCeoDashboard(page) { const kpiData = [ { title: 'Total Revenue', value: '$12,450,000', change: '+15.2% from last month'}, { title: 'Active Deals', value: '32', change: '+5 from last week'}, { title: 'New Leads (Today)', value: '18', change: '+2 since yesterday' }, { title: 'Conversion Rate', value: '4.8%', change: '-0.2% from last month' }]; page.innerHTML = `<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-4">${kpiData.map(kpi => `<div class="bg-white border rounded-lg p-4"><h3 class="text-sm font-medium text-muted-foreground">${kpi.title}</h3><p class="text-2xl font-bold mt-4">${kpi.value}</p><p class="text-xs text-muted-foreground">${kpi.change}</p></div>`).join('')}</div><div class="grid gap-6 mt-6 grid-cols-1 lg:grid-cols-3"><div class="lg:col-span-2 bg-white border rounded-lg p-4"><h3 class="font-semibold mb-4">Team Pulse</h3><table class="w-full text-sm"><thead><tr class="text-left text-muted-foreground"><th class="py-2">Agent</th><th>Active Dialogs</th><th>Avg. Response</th><th>Conversion</th></tr></thead><tbody>${teamPulseData.map(p => `<tr class="border-b"><td class="py-3 font-medium">${p.agent}</td><td>${p.dialogs}</td><td>${p.responseTime}</td><td>${p.conversion}</td></tr>`).join('')}</tbody></table></div><div class="bg-white border rounded-lg p-4 flex flex-col justify-center items-center text-center"><div class="bg-yellow-100 text-yellow-800 rounded-full p-3">${ICONS.anomaly}</div><h3 class="font-semibold mt-4">AI Anomaly Detected</h3><p class="text-sm text-muted-foreground mt-1">${ceoAnomaly.agent}'s ${ceoAnomaly.metric} is ${ceoAnomaly.value}. <a href="#" class="text-accent font-medium">Review</a></p></div></div><div class="mt-6 bg-white border rounded-lg p-4"><h3 class="font-semibold mb-4">Leads per Week</h3><div class="h-64"><canvas id="ceoLeadsChart"></canvas></div></div>`; renderCeoCharts(); }
    function renderAgentDashboard(page) { page.innerHTML = `<div class="bg-white border rounded-lg p-6"><h3 class="font-semibold text-xl mb-4">My Focus Today</h3><div class="border-b"><nav class="-mb-px flex gap-6" id="focus-tabs">
                <button class="focus-tab tab-active py-3 border-b-2" data-tab="hot-leads">🔥 Hot Leads (3)</button>
                <button class="focus-tab py-3 border-b-2 border-transparent text-muted-foreground" data-tab="approvals">👍 Awaiting Approval (1)</button>
                <button class="focus-tab py-3 border-b-2 border-transparent text-muted-foreground" data-tab="tasks">❗ Urgent Tasks (1)</button>
            </nav></div><div class="pt-6"><div id="tab-hot-leads" class="focus-tab-content space-y-3">${dealsData.slice(0, 3).map(deal => `<a href="#deal-details/${deal.id}" class="block p-3 border rounded-md hover:bg-muted"><b>${deal.client}:</b> ${deal.summary}</a>`).join('')}</div><div id="tab-approvals" class="focus-tab-content page-hidden space-y-3">${assistantDialogs.filter(d => d.status === 'Approval Needed').map(d => `<div data-offer-id="${d.id}" class="approval-item cursor-pointer p-3 border rounded-md hover:bg-muted"><b>${d.client}:</b> Jessica has prepared a new offer. Click to review and send.</div>`).join('')}</div><div id="tab-tasks" class="focus-tab-content page-hidden space-y-3">${tasksData.filter(t => t.status === 'Overdue').map(t => `<a href="#tasks" class="block p-3 border rounded-md hover:bg-muted"><b>Overdue Task:</b> ${t.title}</a>`).join('')}</div></div></div><div class="grid gap-6 mt-6 grid-cols-1 lg:grid-cols-2"><div class="bg-white border rounded-lg p-4"><h3 class="font-semibold mb-4">My Deal Pipeline</h3><div class="h-64"><canvas id="agentPipelineChart"></canvas></div></div><div class="bg-white border rounded-lg p-4"><h3 class="font-semibold mb-4">My Recent Activity</h3><div class="space-y-3 text-sm"><p><span class="font-semibold">Jessica</span> sent an offer to Elon Musk.</p><p>You closed the deal for <span class="font-semibold">Villa in Palm Jumeirah</span>.</p><p>New task assigned: <span class="font-semibold">Follow up with Jeff Bezos</span>.</p></div></div></div>`; renderAgentCharts(); }
    function renderMyAssistantPage() {
    const page = document.getElementById('page-my-assistant');
    
    // Предустановленные вопросы - сокращены для минимализма
    const presetQuestions = [
        "🔥 Горячие лиды сегодня",
        "💼 Активные сделки",
        "📊 Отчет по конверсии",
        "🏠 Новые объекты",
        "📞 Звонки на сегодня",
        "📈 Анализ рынка"
    ];
    
    page.innerHTML = `
        <div class="max-w-5xl mx-auto px-4 py-6">

            
            <!-- Быстрые команды - горизонтальная прокрутка -->
            <div class="mb-8">
                <div class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
                    ${presetQuestions.map(question => `
                        <button class="preset-question quick-command-btn flex-shrink-0 border border-gray-300 rounded-md px-3 py-2 text-sm hover:bg-gray-50">${question}</button>
                    `).join('')}
                </div>
            </div>
            
            <!-- Основная область чата - центрированная -->
            <div class="max-w-4xl mx-auto">
                
                <!-- Основная область чата -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col h-[70vh] min-h-[500px]">
                    <!-- Статус бар чата -->
                    <div class="px-6 py-4 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-3 h-3 bg-green-500 rounded-full status-indicator"></div>
                                <span class="text-sm font-medium text-gray-900">Ассистент активен</span>
                            </div>
                            <div class="text-xs text-gray-500">Среднее время ответа: 1.2с</div>
                        </div>
                    </div>
                    
                    <!-- Область сообщений -->
                    <div id="chat-messages" class="flex-1 overflow-y-auto px-6 py-6 space-y-6">
                        <!-- Приветственное сообщение -->
                        <div class="flex items-start gap-4">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <svg class="h-5 w-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                                    <path d="M2 17l10 5 10-5"/>
                                    <path d="M2 12l10 5 10-5"/>
                                </svg>
                            </div>
                            <div class="bg-gray-50 rounded-2xl rounded-tl-md p-4 max-w-[85%]">
                                <p class="text-gray-800 leading-relaxed">Привет! Я ваш персональный AI-ассистент по недвижимости. Готов помочь с анализом лидов, созданием отчетов и поиском информации о клиентах.</p>
                                <div class="flex items-center gap-3 mt-3 pt-2 border-t border-gray-200">
                                    <span class="text-xs text-gray-500">Сейчас</span>
                                    <button class="copy-message text-xs font-medium text-gray-600 hover:text-gray-800">Копировать</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Форма ввода -->
                    <div class="px-6 py-4 border-t border-gray-100">
                        <form id="chat-form" class="flex gap-3">
                            <div class="flex-1 relative">
                                <input 
                                    type="text" 
                                    id="chat-input" 
                                    placeholder="Задайте вопрос ассистенту..." 
                                    class="w-full px-4 py-3 pr-12 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all duration-200 text-gray-900 placeholder-gray-500"
                                    autocomplete="off"
                                >
                                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600" id="search-btn" title="Поиск в истории">
                                    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="m21 21-4.35-4.35"/>
                                    </svg>
                                </button>
                            </div>
                            <button type="submit" class="btn-primary bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 flex items-center gap-2 font-medium shadow-sm">
                                <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="22" y1="2" x2="11" y2="13"/>
                                    <polygon points="22,2 15,22 11,13 2,9"/>
                                </svg>
                                <span class="hidden sm:inline">Отправить</span>
                            </button>
                        </form>
                    </div>
                    </div>
                </div>
            </div>
            
            <!-- Статистика и настройки - компактный блок -->
            <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Статистика -->
                <div class="stat-card bg-white rounded-xl border border-gray-100 p-6">
                    <h3 class="font-medium text-gray-900 mb-4">Статистика сегодня</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">12</div>
                            <div class="text-xs text-gray-500">Запросов</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">1.2с</div>
                            <div class="text-xs text-gray-500">Ответ</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600">8</div>
                            <div class="text-xs text-gray-500">Решено</div>
                        </div>
                    </div>
                </div>
                
                <!-- Настройки -->
                <div class="stat-card bg-white rounded-xl border border-gray-100 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-medium text-gray-900">Настройки</h3>
                            <p class="text-sm text-gray-500 mt-1">Персонализация ассистента</p>
                        </div>
                        <a href="#my-assistant-settings" class="bg-gray-900 text-white px-4 py-2 rounded-lg font-medium hover:bg-gray-800 transition-colors inline-block">Настроить</a>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Инициализация обработчиков событий
    initializeChatHandlers();
    
    // Загружаем историю диалогов при открытии страницы
    updateChatHistoryDisplay();
}

// Функция инициализации обработчиков чата
function initializeChatHandlers() {
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');
    const presetButtons = document.querySelectorAll('.preset-question');
    
    // Обработчик отправки формы
    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (message) {
                addUserMessage(message);
                chatInput.value = '';
                // Симуляция ответа ассистента
                setTimeout(() => {
                    addAssistantMessage(generateAssistantResponse(message));
                }, 1000);
            }
        });
    }
    
    // Обработчики предустановленных вопросов
    presetButtons.forEach(button => {
        button.addEventListener('click', function() {
            const question = this.textContent.trim();
            chatInput.value = question;
            chatInput.focus();
        });
    });
    
    // Обработчики копирования сообщений
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('copy-message')) {
            const messageText = e.target.closest('.bg-muted').querySelector('p').textContent;
            navigator.clipboard.writeText(messageText).then(() => {
                e.target.textContent = 'Скопировано!';
                setTimeout(() => {
                    e.target.textContent = 'Копировать';
                }, 2000);
            });
        }
    });
}

// Функция добавления сообщения пользователя
function addUserMessage(message) {
    const chatMessages = document.getElementById('chat-messages');
    
    // Добавляем разделитель если есть предыдущие сообщения
    if (chatMessages.children.length > 0) {
        const separator = document.createElement('div');
        separator.className = 'message-separator';
        chatMessages.appendChild(separator);
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message flex items-start gap-3 justify-end';
    messageDiv.innerHTML = `
        <div class="user-message text-white rounded-lg p-3 max-w-[80%]">
            <p class="text-sm">${message}</p>
            <div class="flex items-center gap-2 mt-2 justify-end">
                <span class="chat-timestamp">Сейчас</span>
            </div>
        </div>
        <div class="user-avatar w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">
            <span class="text-xs font-bold">${state.currentUserRole.substring(0,2)}</span>
        </div>
    `;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Сохраняем сообщение в историю
    saveChatMessage(message, 'user');
}

// Функция добавления ответа ассистента
function addAssistantMessage(message) {
    const chatMessages = document.getElementById('chat-messages');
    
    // Добавляем разделитель если есть предыдущие сообщения
    if (chatMessages.children.length > 0) {
        const separator = document.createElement('div');
        separator.className = 'message-separator';
        chatMessages.appendChild(separator);
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message flex items-start gap-3';
    messageDiv.innerHTML = `
        <div class="assistant-avatar w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">
            <svg class="h-4 w-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 8V4H8"/>
                <rect x="4" y="4" width="16" height="16" rx="2"/>
            </svg>
        </div>
        <div class="assistant-message rounded-lg p-3 max-w-[80%]">
            <p class="text-sm">${message}</p>
            <div class="flex items-center gap-2 mt-2">
                <span class="chat-timestamp">Сейчас</span>
                <button class="copy-message text-xs text-accent hover:underline">Копировать</button>
            </div>
        </div>
    `;
    chatMessages.appendChild(messageDiv);
    
    // Сохраняем сообщение в историю
    saveChatMessage(message, 'assistant');
    
    // Сохраняем диалог в историю после получения ответа ассистента
    saveDialogToHistory();
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Функция генерации ответа ассистента (симуляция)
function generateAssistantResponse(userMessage) {
    const responses = {
        'горячие лиды': '🔥 **Найдено 3 горячих лида на сегодня:**\n\n1. **Elon Musk** - Интерес к пентхаусу в центре, бюджет $2M\n2. **Jeff Bezos** - Ищет виллу у моря, бюджет $5M\n3. **Bill Gates** - Коммерческая недвижимость, бюджет $10M\n\n✅ Все лиды активны и ожидают контакта в течение дня.',
        'сделки': '💼 **У вас 5 активных сделок, требующих внимания:**\n\n• **Villa Paradise** - ожидает подписания (Elon Musk)\n• **Downtown Penthouse** - на стадии переговоров\n• **Seaside Resort** - требует уточнения деталей\n\n💰 Общая сумма сделок: $12.5M',
        'конверсия': '📊 **Отчет по конверсии за неделю:**\n\n📈 **Общая конверсия**: 4.8%\n🚀 **Рост**: +0.3% к прошлой неделе\n🎯 **Лучший день**: Вторник (6.2%)\n📞 **Источник**: Холодные звонки показали лучший результат',
        'бюджет': '💰 **Клиенты с бюджетом выше $500K:**\n\n💎 **Elon Musk** - $2M (активен)\n💎 **Jeff Bezos** - $5M (горячий лид)\n💎 **Bill Gates** - $10M (переговоры)\n💎 **Warren Buffett** - $1.5M (рассматривает)\n\n📊 Всего: 4 клиента, общий потенциал $18.5M',
        'агенты': '👥 **Статистика по агентам:**\n\n🥇 **Jessica Smith**: 8 активных диалогов, конверсия 6.2%\n🥈 **Michael Johnson**: 12 лидов, конверсия 4.1%\n🥉 **Sarah Davis**: 6 сделок в работе, конверсия 5.8%\n\n🏆 Лидер недели: Jessica Smith',
        'задачи': '⏰ **Просроченные задачи:**\n\n🔴 **Звонок Jeff Bezos** - просрочено на 2 дня\n🔴 **Подготовка договора Villa Paradise** - просрочено на 1 день\n🟡 **Встреча с Bill Gates** - сегодня в 15:00\n\n⚡ Рекомендую срочно обработать эти задачи.',
        'объекты': '🏠 **Новые объекты недвижимости:**\n\n🆕 **Luxury Villa**, Palm Jumeirah - $3.2M\n🆕 **Penthouse**, Downtown Dubai - $2.8M\n🆕 **Townhouse**, Arabian Ranches - $1.5M\n🆕 **Office Space**, DIFC - $4.1M\n\n📅 Все объекты добавлены за последние 24 часа',
        'звонки': '📞 **Список звонков на сегодня:**\n\n🔥 **14:00** - Elon Musk (горячий лид)\n📋 **15:30** - Sarah Connor (уточнить детали)\n💼 **16:00** - Warren Buffett (новое предложение)\n📊 **17:00** - Bill Gates (финальные переговоры)\n\n⏰ Следующий звонок через 2 часа',
        'анализ': '📈 **Анализ рынка недвижимости:**\n\n📊 Средняя цена: $1.8M (+5% за месяц)\n🏠 Самый популярный тип: Виллы (40%)\n📍 Топ-район: Palm Jumeirah\n⏱️ Среднее время продажи: 45 дней\n\n🎯 **Рекомендация**: фокус на премиум-сегменте',
        'перспективные': '🎯 **Топ-5 перспективных клиентов:**\n\n1. 💎 **Elon Musk** - $2.5M (вероятность 85%)\n2. 💎 **Jeff Bezos** - $1.8M (вероятность 70%)\n3. 💎 **Bill Gates** - $3.2M (вероятность 60%)\n4. 💰 **Warren Buffett** - $900K (вероятность 55%)\n5. 💰 **Tim Cook** - $1.2M (вероятность 45%)\n\n🚀 **Общий потенциал**: $9.6M',
        'план': '📋 **План работы на завтра:**\n\n🌅 **09:00** - Звонок Elon Musk\n📊 **10:30** - Подготовка отчета по продажам\n🏠 **12:00** - Показ объекта Jeff Bezos\n📞 **14:00** - Обзвон новых лидов\n📝 **16:00** - Обновление CRM\n\n✅ 5 задач запланировано',
        'презентация': '💬 **Подготовка презентации для клиента:**\n\n📋 Выберите тип презентации:\n• 🏠 Объект недвижимости\n• 💰 Инвестиционное предложение\n• 📊 Аналитический отчет\n• 🎯 Персональное предложение\n\n⚡ Презентация будет готова за 15 минут'
    };
    
    const lowerMessage = userMessage.toLowerCase();
    
    for (const [key, response] of Object.entries(responses)) {
        if (lowerMessage.includes(key)) {
            return response;
        }
    }
    
    return 'Понял ваш запрос. Анализирую данные... 🤔\n\nК сожалению, я не нашел точного соответствия в базе данных. Попробуйте переформулировать вопрос или воспользуйтесь быстрыми командами слева.';
}

// Инициализация обработчиков событий для чата
function initChatHandlers() {
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    const presetQuestions = document.querySelectorAll('.preset-question');
    
    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (message) {
                addMessage(message, 'user');
                chatInput.value = '';
                
                // Симуляция ответа ассистента
                setTimeout(() => {
                    const response = generateAssistantResponse(message);
                    addMessage(response, 'assistant');
                }, 1000);
            }
        });
    }
    
    // Обработчики для предустановленных вопросов
    presetQuestions.forEach(button => {
        button.addEventListener('click', function() {
            const command = this.textContent.trim();
            addMessage(command, 'user');
            
            // Визуальная обратная связь
            this.style.backgroundColor = '#e5e7eb';
            setTimeout(() => {
                this.style.backgroundColor = '';
            }, 200);
            
            setTimeout(() => {
                const response = generateAssistantResponse(command);
                addMessage(response, 'assistant');
            }, 1000);
        });
    });
    
    // Автофокус на поле ввода
    if (chatInput) {
        chatInput.focus();
    }
}

// Добавление сообщения в чат
function addMessage(message, sender) {
    const messagesContainer = document.getElementById('chatMessages');
    if (!messagesContainer) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex gap-3 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
    
    const isUser = sender === 'user';
    const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    messageDiv.innerHTML = `
        <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg relative group ${
            isUser 
                ? 'bg-blue-500 text-white' 
                : 'bg-gray-100 text-gray-800'
        }">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <p class="text-sm whitespace-pre-wrap" id="${messageId}">${message}</p>
                    <p class="text-xs mt-1 opacity-70">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</p>
                </div>
                ${!isUser ? `
                    <button onclick="copyMessage('${messageId}')" 
                            class="ml-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 p-1 rounded hover:bg-gray-200 flex-shrink-0"
                            title="Копировать сообщение">
                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Функция для копирования сообщения
function copyMessage(messageId) {
    const messageElement = document.getElementById(messageId);
    if (!messageElement) return;
    
    const text = messageElement.textContent;
    
    // Используем современный API Clipboard
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
            showCopyNotification();
        }).catch(err => {
            console.error('Ошибка копирования:', err);
            fallbackCopyTextToClipboard(text);
        });
    } else {
        fallbackCopyTextToClipboard(text);
    }
}

// Резервный метод копирования для старых браузеров
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showCopyNotification();
    } catch (err) {
        console.error('Ошибка копирования:', err);
    }
    
    document.body.removeChild(textArea);
}

// Показать уведомление о копировании
function showCopyNotification() {
    // Создаем временное уведомление
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
    notification.textContent = '✅ Сообщение скопировано!';
    
    document.body.appendChild(notification);
    
    // Удаляем уведомление через 2 секунды
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(-20px)';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 2000);
}

// Переменная для хранения текущего диалога
let currentDialog = {
    messages: [],
    startTime: null,
    userQuestion: '',
    assistantResponse: ''
};

// Функция сохранения сообщения в текущий диалог
function saveChatMessage(message, sender) {
    if (!currentDialog.startTime) {
        currentDialog.startTime = new Date();
    }
    
    currentDialog.messages.push({
        text: message,
        sender: sender,
        timestamp: new Date()
    });
    
    if (sender === 'user') {
        currentDialog.userQuestion = message;
    } else if (sender === 'assistant') {
        currentDialog.assistantResponse = message;
    }
}

// Функция сохранения диалога в историю
function saveDialogToHistory() {
    if (currentDialog.messages.length >= 2) {
        const dialogHistory = getChatHistory();
        
        const dialogSummary = {
            id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            title: generateDialogTitle(currentDialog.userQuestion),
            userQuestion: currentDialog.userQuestion,
            assistantResponse: currentDialog.assistantResponse,
            timestamp: currentDialog.startTime,
            messages: [...currentDialog.messages]
        };
        
        dialogHistory.unshift(dialogSummary);
        
        // Ограничиваем историю 50 диалогами
        if (dialogHistory.length > 50) {
            dialogHistory.splice(50);
        }
        
        localStorage.setItem('chatHistory', JSON.stringify(dialogHistory));
        
        // Обновляем отображение истории
        updateChatHistoryDisplay();
        
        // Сбрасываем текущий диалог
        currentDialog = {
            messages: [],
            startTime: null,
            userQuestion: '',
            assistantResponse: ''
        };
    }
}

// Функция получения истории диалогов
function getChatHistory() {
    try {
        const history = localStorage.getItem('chatHistory');
        return history ? JSON.parse(history) : [];
    } catch (error) {
        console.error('Ошибка при загрузке истории:', error);
        return [];
    }
}

// Функция генерации заголовка диалога
function generateDialogTitle(userQuestion) {
    const question = userQuestion.toLowerCase();
    
    if (question.includes('лид') || question.includes('горяч')) {
        return 'Анализ горячих лидов';
    } else if (question.includes('сделк') || question.includes('deal')) {
        return 'Информация о сделках';
    } else if (question.includes('конверс') || question.includes('conversion')) {
        return 'Отчет по конверсии';
    } else if (question.includes('бюджет') || question.includes('budget')) {
        return 'Анализ бюджета';
    } else if (question.includes('агент') || question.includes('команд')) {
        return 'Информация о команде';
    } else if (question.includes('задач') || question.includes('task')) {
        return 'Управление задачами';
    } else if (question.includes('объект') || question.includes('недвижим')) {
        return 'Каталог объектов';
    } else if (question.includes('звонок') || question.includes('call')) {
        return 'Анализ звонков';
    } else if (question.includes('анализ') || question.includes('отчет')) {
        return 'Аналитический отчет';
    } else {
        return userQuestion.length > 30 ? userQuestion.substring(0, 30) + '...' : userQuestion;
    }
}

// Функция обновления отображения истории
function updateChatHistoryDisplay() {
    const historyContainer = document.getElementById('chat-history');
    if (!historyContainer) return;
    
    const history = getChatHistory();
    
    if (history.length === 0) {
        historyContainer.innerHTML = '<p class="text-sm text-muted-foreground text-center py-4">История диалогов пуста</p>';
        return;
    }
    
    historyContainer.innerHTML = history.map(dialog => {
        const timeAgo = getTimeAgo(dialog.timestamp);
        return `
            <div class="p-3 border rounded-md hover:bg-muted cursor-pointer" onclick="loadDialog('${dialog.id}')">
                <div class="flex justify-between items-start mb-1">
                    <span class="font-medium text-sm">${dialog.title}</span>
                    <span class="text-xs text-muted-foreground">${timeAgo}</span>
                </div>
                <p class="text-sm text-muted-foreground mb-1">Вы: "${dialog.userQuestion.length > 50 ? dialog.userQuestion.substring(0, 50) + '...' : dialog.userQuestion}"</p>
                <p class="text-sm text-muted-foreground">Ассистент: "${dialog.assistantResponse.length > 50 ? dialog.assistantResponse.substring(0, 50) + '...' : dialog.assistantResponse}"</p>
            </div>
        `;
    }).join('');
}

// Функция получения времени "назад"
function getTimeAgo(timestamp) {
    const now = new Date();
    const dialogTime = new Date(timestamp);
    const diffMs = now - dialogTime;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) {
        return 'Только что';
    } else if (diffMins < 60) {
        return `${diffMins} мин назад`;
    } else if (diffHours < 24) {
        return `${diffHours} ч назад`;
    } else if (diffDays === 1) {
        return 'Вчера';
    } else if (diffDays < 7) {
        return `${diffDays} дн назад`;
    } else {
        return dialogTime.toLocaleDateString('ru-RU');
    }
}

// Функция загрузки диалога в чат
function loadDialog(dialogId) {
    const history = getChatHistory();
    const dialog = history.find(d => d.id === dialogId);
    
    if (!dialog) return;
    
    // Очищаем текущий чат
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
        chatMessages.innerHTML = '';
    }
    
    // Загружаем сообщения из диалога
    dialog.messages.forEach(msg => {
        if (msg.sender === 'user') {
            addMessage(msg.text, 'user');
        } else {
            addMessage(msg.text, 'assistant');
        }
    });
}

// Функция очистки истории
function clearChatHistory() {
    if (confirm('Вы уверены, что хотите очистить всю историю диалогов?')) {
        localStorage.removeItem('chatHistory');
        updateChatHistoryDisplay();
        
        // Показываем уведомление
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        notification.textContent = '🗑️ История очищена';
        document.body.appendChild(notification);
        
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 2000);
    }
}
    function renderMyAssistantSettingsPage() {
    const page = document.getElementById('page-my-assistant-settings');
    page.innerHTML = `
        <div class="space-y-6">
            <!-- Основные настройки ассистента -->
            <div class="bg-white border rounded-lg">
                <div class="p-4 border-b">
                    <h3 class="font-semibold">Настройки ассистента</h3>
                </div>
                <div class="p-6 space-y-6">
                    <div>
                        <label class="block text-sm font-medium mb-1">Имя ассистента</label>
                        <input type="text" value="AI Assistant" class="w-full p-2 border rounded-md max-w-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Персональный промпт</label>
                        <textarea class="w-full p-2 border rounded-md h-32" placeholder="Опишите, как должен вести себя ваш ассистент...">Вы - профессиональный ИИ-ассистент для работы с недвижимостью. Будьте дружелюбны, эффективны и всегда готовы помочь с задачами клиента.</textarea>
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="block text-sm font-medium">Использовать данные от всех агентов</label>
                        <div class="relative inline-block w-10 align-middle select-none">
                            <input type="checkbox" name="toggle" id="toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Предустановленные шаблоны стилей общения -->
            <div class="bg-white border rounded-lg">
                <div class="p-4 border-b">
                    <h3 class="font-semibold">Стили общения</h3>
                </div>
                <div class="p-6">
                    <div class="grid gap-4 md:grid-cols-3">
                        <div class="border rounded-lg p-4 cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition-colors" onclick="selectCommunicationStyle('formal')">
                            <div class="flex items-center gap-2 mb-2">
                                <input type="radio" name="communication-style" value="formal" class="text-blue-600">
                                <h4 class="font-medium">Формальный</h4>
                            </div>
                            <p class="text-sm text-gray-600">Профессиональный и деловой стиль общения для корпоративной среды</p>
                        </div>
                        <div class="border rounded-lg p-4 cursor-pointer hover:bg-green-50 hover:border-green-300 transition-colors" onclick="selectCommunicationStyle('friendly')">
                            <div class="flex items-center gap-2 mb-2">
                                <input type="radio" name="communication-style" value="friendly" class="text-green-600" checked>
                                <h4 class="font-medium">Дружелюбный</h4>
                            </div>
                            <p class="text-sm text-gray-600">Теплый и приветливый стиль для создания комфортной атмосферы</p>
                        </div>
                        <div class="border rounded-lg p-4 cursor-pointer hover:bg-purple-50 hover:border-purple-300 transition-colors" onclick="selectCommunicationStyle('brief')">
                            <div class="flex items-center gap-2 mb-2">
                                <input type="radio" name="communication-style" value="brief" class="text-purple-600">
                                <h4 class="font-medium">Краткий</h4>
                            </div>
                            <p class="text-sm text-gray-600">Лаконичные и четкие ответы для быстрого решения задач</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Настройки уведомлений -->
            <div class="bg-white border rounded-lg">
                <div class="p-4 border-b">
                    <h3 class="font-semibold">Уведомления</h3>
                </div>
                <div class="p-6 space-y-6">
                    <div>
                        <h4 class="font-medium mb-3">Условия срабатывания</h4>
                        <div class="space-y-3">
                            <label class="flex items-center gap-3">
                                <input type="checkbox" class="rounded" checked>
                                <span class="text-sm">Новые горячие лиды</span>
                            </label>
                            <label class="flex items-center gap-3">
                                <input type="checkbox" class="rounded" checked>
                                <span class="text-sm">Требуется одобрение предложения</span>
                            </label>
                            <label class="flex items-center gap-3">
                                <input type="checkbox" class="rounded">
                                <span class="text-sm">Просроченные задачи</span>
                            </label>
                            <label class="flex items-center gap-3">
                                <input type="checkbox" class="rounded">
                                <span class="text-sm">Важные обновления сделок</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-medium mb-3">Способы получения уведомлений</h4>
                        <div class="grid gap-3 md:grid-cols-2">
                            <label class="flex items-center gap-3">
                                <input type="checkbox" class="rounded" checked>
                                <span class="text-sm">В приложении</span>
                            </label>
                            <label class="flex items-center gap-3">
                                <input type="checkbox" class="rounded">
                                <span class="text-sm">Email</span>
                            </label>
                            <label class="flex items-center gap-3">
                                <input type="checkbox" class="rounded">
                                <span class="text-sm">SMS</span>
                            </label>
                            <label class="flex items-center gap-3">
                                <input type="checkbox" class="rounded">
                                <span class="text-sm">Push-уведомления</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Интеграции -->
            <div class="bg-white border rounded-lg">
                <div class="p-4 border-b">
                    <h3 class="font-semibold">Интеграции</h3>
                </div>
                <div class="p-6">
                    <div class="grid gap-4 md:grid-cols-2">
                        <div class="border rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zM4 7h12v9H4V7z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="font-medium">Календарь</h4>
                                        <p class="text-sm text-gray-600">Google Calendar</p>
                                    </div>
                                </div>
                                <button class="text-sm bg-green-100 text-green-800 px-3 py-1 rounded-full">Подключено</button>
                            </div>
                            <p class="text-xs text-gray-500">Синхронизация встреч и напоминаний</p>
                        </div>

                        <div class="border rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="font-medium">WhatsApp</h4>
                                        <p class="text-sm text-gray-600">Business API</p>
                                    </div>
                                </div>
                                <button class="text-sm bg-gray-100 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-200 transition-colors">Подключить</button>
                            </div>
                            <p class="text-xs text-gray-500">Отправка сообщений клиентам</p>
                        </div>

                        <div class="border rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-4 h-4 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="font-medium">Email</h4>
                                        <p class="text-sm text-gray-600">SMTP/Gmail</p>
                                    </div>
                                </div>
                                <button class="text-sm bg-green-100 text-green-800 px-3 py-1 rounded-full">Подключено</button>
                            </div>
                            <p class="text-xs text-gray-500">Автоматические email-кампании</p>
                        </div>

                        <div class="border rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="font-medium">CRM</h4>
                                        <p class="text-sm text-gray-600">Salesforce/HubSpot</p>
                                    </div>
                                </div>
                                <button class="text-sm bg-gray-100 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-200 transition-colors">Подключить</button>
                            </div>
                            <p class="text-xs text-gray-500">Синхронизация контактов и сделок</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Кнопка сохранения -->
            <div class="flex justify-end">
                <button onclick="saveAssistantSettings()" class="bg-black text-white py-2 px-6 rounded-md font-medium hover:bg-gray-800 transition-colors">Сохранить изменения</button>
            </div>
        </div>
    `;
    }

    function saveAssistantSettings() {
        // Получаем значения из формы
        const assistantName = document.getElementById('assistant-name')?.value || 'My Assistant';
        const language = document.getElementById('language')?.value || 'ru';
        const tone = document.getElementById('tone')?.value || 'professional';
        const responseSpeed = document.getElementById('response-speed')?.value || 'normal';
        const emailNotifications = document.getElementById('email-notifications')?.checked || false;
        const smsNotifications = document.getElementById('sms-notifications')?.checked || false;
        const whatsappIntegration = document.getElementById('whatsapp-integration')?.checked || false;
        const telegramIntegration = document.getElementById('telegram-integration')?.checked || false;
        
        // Сохраняем настройки (в реальном приложении здесь был бы API вызов)
        const settings = {
            assistantName,
            language,
            tone,
            responseSpeed,
            notifications: {
                email: emailNotifications,
                sms: smsNotifications
            },
            integrations: {
                whatsapp: whatsappIntegration,
                telegram: telegramIntegration
            },
            savedAt: new Date().toISOString()
        };
        
        // Сохраняем в localStorage для демонстрации
        localStorage.setItem('assistantSettings', JSON.stringify(settings));
        
        // Показываем уведомление об успешном сохранении
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg z-50';
        notification.textContent = 'Настройки успешно сохранены!';
        document.body.appendChild(notification);
        
        // Убираем уведомление через 3 секунды
        setTimeout(() => {
            notification.remove();
        }, 3000);
        
        console.log('Assistant settings saved:', settings);
    }

    function renderDealsPage() {
        const page = document.getElementById('page-deals');
        const statuses = ['New Lead', 'Qualified', 'Offer Sent', 'Negotiation'];
        const assistantName = state.currentUserRole === 'CEO' ? 'Leonardo' : 'Jessica';
        page.innerHTML = `<div class="bg-white border rounded-lg"><div class="p-4 flex justify-between items-center border-b"><h3 class="font-semibold">All Deals</h3><button class="px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">Add Deal</button></div><div class="space-y-4 p-4">${statuses.map(status => { const statusDeals = dealsData.filter(d => d.status === status); if (statusDeals.length === 0) return ''; return `<details open><summary class="font-semibold mb-3 cursor-pointer flex items-center justify-between py-2"><span>${status} (${statusDeals.length})</span><span class="transform transition-transform">${ICONS.chevron}</span></summary><div class="collapsible-content"><div class="border rounded-md"><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Deal</th><th class="px-6 py-3">Client</th><th class="px-6 py-3">Amount</th><th class="px-6 py-3">Agent</th><th class="px-6 py-3">Offer</th></tr></thead><tbody>${statusDeals.map((deal, index) => `<tr class="bg-white border-b hover:bg-muted cursor-pointer" onclick="window.location.hash = '#deal-details/${deal.id}'"><td class="px-6 py-4 font-medium align-middle"><div>${deal.title}</div>${index % 2 === 0 ? `<div class="flex items-center gap-1 text-xs text-accent mt-1">${ICONS.bot} ${assistantName}</div>` : ''}</td><td class="px-6 py-4 align-middle">${deal.client}</td><td class="px-6 py-4 align-middle">$${deal.amount.toLocaleString()}</td><td class="px-6 py-4 align-middle">${deal.agent}</td><td class="px-6 py-4 align-middle">${deal.offerUrl ? `<a href="${deal.offerUrl}" class="font-medium text-accent hover:underline">View Offer</a>` : '-'}</td></tr>`).join('')}</tbody></table></div></div></div></details>` }).join('')}</div></div>`; }
    function renderDealDetailsPage(dealId) { const page = document.getElementById('page-deal-details'); const deal = dealsData.find(d => d.id === dealId) || dealsData[0]; const assistantName = state.currentUserRole === 'CEO' ? 'Leonardo' : 'Jessica'; page.innerHTML = `<div><a href="#deals" class="text-sm font-medium mb-4 inline-block">&larr; Back to Deals</a><div class="bg-white border rounded-lg"><div class="p-6"><h2 class="text-2xl font-bold">${deal.title}</h2><p class="text-muted-foreground">Client: ${deal.client} | Agent: ${deal.agent}</p></div><div class="p-6 border-t bg-blue-50/50"><div class="flex items-center gap-3 mb-2"><span class="text-accent">${ICONS.bot}</span><h3 class="font-semibold">Summary from ${assistantName}</h3></div><p class="text-sm text-gray-800">${deal.summary}</p></div><div class="p-6 border-t"><h3 class="font-semibold mb-2">Chat Log with ${assistantName}</h3><div class="h-40 overflow-y-auto bg-muted p-3 rounded-md text-sm space-y-3"><p><b>${assistantName}:</b> Hello ${deal.client}, I'm ${assistantName}, assistant to ${deal.agent}...</p><p class="text-right"><b>${deal.client}:</b> Around $${(deal.amount / 1_000_000).toFixed(1)}M</p><p><b>${assistantName}:</b> Perfect. I have prepared a personalized offer for you...</p></div></div>${deal.feedback ? `<div class="p-6 border-t"><h3 class="font-semibold mb-2">Feedback from Showing</h3><div class="text-sm space-y-2"><div><strong>Liked:</strong> ${deal.feedback.liked}</div><div><strong>Disliked:</strong> ${deal.feedback.disliked}</div><div><strong>Rating:</strong> ${'★'.repeat(deal.feedback.rating)}${'☆'.repeat(5-deal.feedback.rating)}</div><div><strong>AI Next Step:</strong> ${deal.feedback.nextStep}</div></div></div>` : ''}</div></div>`; }
    function renderPropertiesPage() {
        const page = document.getElementById('page-properties');
        page.innerHTML = `
            <div class="space-y-6">
                <!-- Header with Search and Filters -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center w-full sm:w-auto">
                        <input 
                            type="text" 
                            placeholder="Поиск недвижимости..." 
                            class="p-3 border border-gray-300 rounded-lg w-full sm:w-64 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                        <select class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option>Все типы</option>
                            <option>Квартиры</option>
                            <option>Дома</option>
                            <option>Виллы</option>
                            <option>Пентхаусы</option>
                        </select>
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">Фильтр:</label>
                            <div class="flex gap-2">
                                    <button class="px-3 py-2 bg-gray-200 text-gray-800 rounded-full text-sm font-medium hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">Мои объекты</button>
                                    <button class="px-3 py-2 text-gray-600 rounded-full text-sm font-medium hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-500">Все объекты</button>
                                </div>
                        </div>
                    </div>
                    <button class="px-4 py-2 bg-blue-600 text-white rounded-md font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors shadow-sm">+ Добавить объект</button>
                </div>

                <!-- Properties Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    ${propertiesData.map(prop => `
                        <a href="#property-details/${prop.id}" class="bg-white border border-gray-200 rounded-xl overflow-hidden group hover:shadow-lg transition-all duration-300 hover:-translate-y-1">
                            <div class="relative">
                                <img 
                                    src="${prop.image}" 
                                    alt="${prop.name}" 
                                    class="h-48 w-full object-cover group-hover:scale-105 transition-transform duration-300"
                                    loading="lazy"
                                >
                                <div class="absolute top-3 right-3 bg-black/70 text-white text-xs px-3 py-1 rounded-full backdrop-blur-sm">
                                    ${prop.agent}
                                </div>
                                <div class="absolute bottom-3 left-3 bg-white/90 text-gray-800 text-xs px-3 py-1 rounded-full backdrop-blur-sm font-medium">
                                    ${prop.type || 'Недвижимость'}
                                </div>
                            </div>
                            <div class="p-5">
                                <h4 class="font-semibold text-gray-900 mb-2 line-clamp-1">${prop.name}</h4>
                                <p class="text-sm text-gray-600 mb-3 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    ${prop.location}
                                </p>
                                <div class="flex justify-between items-end">
                                    <div>
                                        <p class="text-xl font-bold text-blue-600 mb-1">$${prop.price.toLocaleString()}</p>
                                        <div class="flex items-center text-xs text-gray-500 space-x-3">
                                            <span class="flex items-center">
                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4"></path>
                                                </svg>
                                                ${prop.beds} спален
                                            </span>
                                            <span class="flex items-center">
                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path>
                                                </svg>
                                                ${prop.baths} ванных
                                            </span>
                                            <span class="flex items-center">
                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4a1 1 0 011-1h4m0 0V1m0 2h2m0 0V1m0 2h4a1 1 0 011 1v4m0 0h2m-2 0v2m0 0h2m-2 0v4a1 1 0 01-1 1h-4m0 0v2m0-2h-2m0 0v2m0-2h-4a1 1 0 01-1-1v-4m0 0H1m2 0v-2m0 0H1m2 0V8"></path>
                                                </svg>
                                                ${prop.area} м²
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    `).join('')}
                </div>

                <!-- Empty State -->
                ${propertiesData.length === 0 ? `
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">Нет объектов недвижимости</h3>
                        <p class="mt-1 text-sm text-gray-500">Начните с добавления первого объекта недвижимости.</p>
                        <div class="mt-6">
                            <button class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-4 rounded-lg font-medium transition-colors">
                                + Добавить объект
                            </button>
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    }
    function renderPropertyDetailsPage(propId) { const page = document.getElementById('page-property-details'); const prop = propertiesData.find(p => p.id === propId) || propertiesData[0]; page.innerHTML = `<div><a href="#properties" class="text-sm font-medium mb-4 inline-block">&larr; Back to Properties</a><div class="bg-white border rounded-lg overflow-hidden"><img src="${prop.image}" class="w-full h-96 object-cover"><div class="p-6"><h2 class="text-3xl font-bold">${prop.name}</h2><p class="text-muted-foreground mt-1">${prop.location}</p><div class="mt-4 flex gap-8 text-center border-t border-b py-4"><div><p class="text-2xl font-semibold">${prop.beds}</p><p class="text-sm text-muted-foreground">Beds</p></div><div><p class="text-2xl font-semibold">${prop.baths}</p><p class="text-sm text-muted-foreground">Baths</p></div><div><p class="text-2xl font-semibold">${prop.area.toLocaleString()}</p><p class="text-sm text-muted-foreground">Sqft</p></div><div><p class="text-2xl font-semibold">$${prop.price.toLocaleString()}</p><p class="text-sm text-muted-foreground">Price</p></div></div><p class="mt-4 text-gray-700">A stunning luxury villa offering panoramic sea views...</p></div></div></div>`; }
    function renderTasksPage() { const page = document.getElementById('page-tasks'); const tasksByStatus = { Overdue: tasksData.filter(t => t.status === 'Overdue' && !t.completed), Today: tasksData.filter(t => t.status === 'Today' && !t.completed), Upcoming: tasksData.filter(t => t.status === 'Upcoming' && !t.completed), Completed: tasksData.filter(t => t.completed) }; const assistantName = state.currentUserRole === 'CEO' ? 'Leonardo' : 'Jessica'; page.innerHTML = `<div><div class="flex justify-end items-center mb-4"><button class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-3 font-medium">Add Task</button></div>${Object.entries(tasksByStatus).map(([status, tasks]) => tasks.length > 0 ? `<div class="mb-6"><h3 class="font-semibold mb-2 text-lg">${status} (${tasks.length})</h3><div class="space-y-2">${tasks.map(task => `<div class="bg-white border rounded-md p-3 flex items-center gap-3"><input type="checkbox" ${task.completed ? 'checked' : ''} class="h-5 w-5"><div class="flex-1"><p class="font-medium ${task.completed ? 'line-through text-muted-foreground' : ''}">${task.title}</p><div class="flex items-center gap-2"><a href="#deal-details/1" class="text-xs text-muted-foreground hover:underline">Related Deal: Villa in Palm Jumeirah</a>${task.createdBy === 'Jessica' ? `<span class="flex items-center gap-1 text-xs text-accent bg-blue-50 px-2 py-0.5 rounded-full" title="Created by ${assistantName}">${ICONS.bot} ${assistantName}</span>` : ''}</div></div><span class="text-sm font-medium ${status === 'Overdue' ? 'text-red-600' : 'text-muted-foreground'}">${task.due}</span></div>`).join('')}</div></div>` : '').join('')}</div>`; }
    function renderAnalyticsPage() { const page = document.getElementById('page-analytics'); page.innerHTML = `<div class="bg-white border rounded-lg p-6"><div class="flex justify-between items-center mb-4"><h3 class="font-semibold">Strategic Analytics</h3><button id="generate-forecast-btn" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-3 font-medium">Generate Revenue Forecast</button></div><div class="p-6 border rounded-md bg-blue-50/50"><div class="flex items-center gap-3 mb-2"><span class="text-accent">${ICONS.bot}</span><h3 class="font-semibold">Recommendation from Leonardo</h3></div><p class="text-sm text-gray-800">Data shows that leads from Property Finder convert 10% better. Recommend reallocating 15% of the Bayut budget to maximize ROI.</p></div></div><div class="grid gap-6 mt-6 md:grid-cols-2 lg:grid-cols-7"><div class="lg:col-span-4 bg-white border rounded-lg p-4"><h3 class="font-semibold mb-4">Sales Funnel Conversion</h3><div class="h-80"><canvas id="funnelChart"></canvas></div></div><div class="lg:col-span-3 bg-white border rounded-lg p-4"><h3 class="font-semibold mb-4">Agent Productivity</h3><div class="h-80"><canvas id="agentChart"></canvas></div></div></div>`; renderAnalyticsCharts(); }
    function renderSettingsPage() { const page = document.getElementById('page-settings'); page.innerHTML = `<div><div class="bg-white border rounded-lg"><div class="p-4 border-b"><h3 class="font-semibold">User Management</h3></div><div class="p-6"><button class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-3 font-medium mb-4">Invite User</button><div class="border rounded-lg overflow-hidden"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Name</th><th class="px-6 py-3">Role</th><th class="px-6 py-3">Status</th><th class="px-6 py-3">Action</th></tr></thead><tbody>${Object.values(users).map(user => `<tr class="bg-white border-b hover:bg-muted"><td class="px-6 py-4 font-medium flex items-center gap-3"><img src="${user.avatar}" class="h-8 w-8 rounded-full">${user.name}</td><td class="px-6 py-4">${user.role}</td><td class="px-6 py-4"><span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">Active</span></td><td class="px-6 py-4"><a href="#" class="font-medium text-accent hover:underline">Edit</a></td></tr>`).join('')}</tbody></table></div></div></div></div>`; }
    function renderImportsPage() { const page = document.getElementById('page-imports'); page.innerHTML = `<div class="grid gap-6 grid-cols-1 lg:grid-cols-3"><div class="lg:col-span-1 bg-white border rounded-lg"><div class="p-4 border-b"><h3 class="font-semibold">Import New Leads</h3></div><div class="p-6"><div class="flex items-center justify-center w-full"><label for="dropzone-file" class="flex flex-col items-center justify-center w-full h-64 border-2 border-border border-dashed rounded-lg cursor-pointer bg-muted hover:bg-gray-100"><div class="flex flex-col items-center justify-center pt-5 pb-6"><svg class="w-8 h-8 mb-4 text-gray-500" viewBox="0 0 20 16" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg><p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span></p><p class="text-xs text-gray-500">CSV, XLS, or XLSX</p></div><input id="dropzone-file" type="file" class="hidden" /></label></div></div></div><div class="lg:col-span-2 bg-white border rounded-lg"><div class="p-4 border-b"><h3 class="font-semibold">Distribute Leads</h3></div><div class="grid grid-cols-3 divide-x border-b"><div class="p-4 text-center"><h4 class="text-sm text-muted-foreground">Total Imported</h4><p class="text-2xl font-bold">${importedLeads.length}</p></div><div class="p-4 text-center"><h4 class="text-sm text-muted-foreground">Assigned</h4><p class="text-2xl font-bold">0</p></div><div class="p-4 text-center"><h4 class="text-sm text-muted-foreground">Unassigned</h4><p id="unassigned-count" class="text-2xl font-bold text-accent">${state.unassignedLeads}</p></div></div><div class="p-6"><form id="distribute-form" class="flex items-end gap-4"><div class="flex-1"><label class="block text-sm font-medium mb-1">Number of Leads</label><input id="distribute-count" type="number" min="1" max="${state.unassignedLeads}" value="${state.unassignedLeads}" class="p-2 border rounded-md w-full"></div><button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-3 font-medium">Distribute Randomly</button></form></div></div></div>`; }

    function renderOfferPage(token) { const deal = dealsData.find(d => d.id === parseInt(token)) || dealsData[4]; const offerProperties = propertiesData.slice(0, 3); const offerPage = document.getElementById('page-offer'); offerPage.innerHTML = `<div class="max-w-4xl mx-auto p-6 md:p-12"><header class="text-center mb-12"><svg class="h-10 w-10 mx-auto text-accent mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3L2 9l10 6 10-6-10-6z"/><path d="M2 9l10 6 10-6"/><path d="M2 15l10 6 10-6"/></svg><h1 class="text-3xl font-bold">A Personal Selection for ${deal.client}</h1><p class="text-muted-foreground mt-2">Prepared by Jessica on behalf of Alex Ivanov at AKARIA Portal.</p></header><div class="space-y-8">${offerProperties.map(prop => `<div class="bg-white border rounded-lg overflow-hidden md:flex"><img src="${prop.image}" class="md:w-1/3 h-64 md:h-auto object-cover"><div class="p-6 flex flex-col"><h3 class="text-xl font-semibold">${prop.name}</h3><p class="text-sm text-muted-foreground mt-1">${prop.location}</p><p class="text-gray-700 mt-4 text-sm flex-1">A stunning luxury villa offering panoramic sea views from every room...</p><div class="flex justify-between items-end mt-4"><div><p class="text-lg font-bold text-accent">$${prop.price.toLocaleString()}</p><p class="text-xs text-muted-foreground">${prop.beds} beds • ${prop.baths} baths • ${prop.area} sqft</p></div></div></div></div>`).join('')}</div><footer class="text-center mt-12 border-t pt-8"><h3 class="text-xl font-semibold">Ready for the next step?</h3><p class="text-muted-foreground mt-2">Let us know if any of these properties catch your eye, and Alex Ivanov will personally get in touch.</p><a href="#dashboard" class="mt-6 inline-block bg-accent text-white font-medium py-3 px-8 rounded-lg text-lg">I'm Interested, Contact Me</a></footer></div>`; }

    // -----------------------------------------------------------------------------
    // 4. CHARTS & LIBRARIES INITIALIZATION
    // -----------------------------------------------------------------------------

    let chartInstances = {};
    function destroyAllCharts() { Object.values(chartInstances).forEach(chart => chart.destroy()); chartInstances = {}; }
    function renderAgentCharts() { destroyAllCharts(); const pipelineCtx = document.getElementById('agentPipelineChart')?.getContext('2d'); if (pipelineCtx) { chartInstances.pipeline = new Chart(pipelineCtx, { type: 'bar', data: { labels: ['New', 'Qualified', 'Offer', 'Negotiation'], datasets: [{ label: 'My Deals', data: [2, 3, 1, 2], backgroundColor: ['#93c5fd', '#60a5fa', '#3b82f6', '#2563eb'], borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); } }
    function renderCeoCharts() { destroyAllCharts(); const leadsCtx = document.getElementById('ceoLeadsChart')?.getContext('2d'); if (leadsCtx) { chartInstances.leads = new Chart(leadsCtx, { type: 'line', data: { labels: ['W1', 'W2', 'W3', 'W4', 'W5', 'W6', 'W7', 'W8'], datasets: [{ label: 'New Leads', data: [22, 25, 31, 28, 35, 41, 38, 45], borderColor: '#0070f3', tension: 0.3, fill: false }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); } }
    function renderAnalyticsCharts() { destroyAllCharts(); const funnelCtx = document.getElementById('funnelChart')?.getContext('2d'); const agentCtx = document.getElementById('agentChart')?.getContext('2d'); if(funnelCtx) { chartInstances.funnel = new Chart(funnelCtx, { type: 'bar', data: { labels: ['New Leads', 'Qualified', 'Offer Sent', 'Negotiation', 'Closed'], datasets: [{ label: 'Conversion', data: [100, 62, 45, 25, 15], backgroundColor: ['#2563eb', '#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe'] }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); } if(agentCtx) { chartInstances.agent = new Chart(agentCtx, { type: 'pie', data: { labels: ['Alex Ivanov', 'Anna Petrova', 'Other'], datasets: [{ label: 'Deals Closed (MTD)', data: [12, 9, 5], backgroundColor: ['#2563eb', '#60a5fa', '#bfdbfe'], borderColor: '#fff', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } }); } }

    function renderAssistantActivityChart() {
        const activityCtx = document.getElementById('assistantActivityChart')?.getContext('2d');
        if (activityCtx) {
            // Данные активности за последние 7 дней
            const activityData = {
                labels: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
                datasets: [
                    {
                        label: 'Сообщения отправлены',
                        data: [45, 52, 38, 67, 59, 23, 31],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Лиды обработаны',
                        data: [12, 15, 8, 18, 14, 6, 9],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Встречи назначены',
                        data: [3, 4, 2, 6, 5, 1, 2],
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            };
            
            chartInstances.assistantActivity = new Chart(activityCtx, {
                type: 'line',
                data: activityData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            display: true,
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        }
    }

    // -----------------------------------------------------------------------------
    // 5. MODAL LOGIC
    // -----------------------------------------------------------------------------
    const modal = { container: document.getElementById('modal-container'), title: document.getElementById('modal-title'), body: document.getElementById('modal-body'), closeBtn: document.getElementById('modal-close-btn') };
    function showModal(title, contentHTML) { modal.title.textContent = title; modal.body.innerHTML = contentHTML; modal.container.dataset.state = 'open'; }
    function hideModal() { modal.container.dataset.state = 'closed'; }
    modal.closeBtn.onclick = hideModal;
    modal.container.onclick = (e) => { if (e.target === modal.container) hideModal(); };

    // -----------------------------------------------------------------------------
    // 6. EVENT LISTENERS & INITIALIZATION
    // -----------------------------------------------------------------------------
    
    function updateUserUI() {
        const user = users[state.currentUserRole];
        document.getElementById('user-avatar').src = user.avatar;
        document.getElementById('user-name').textContent = user.name;
        document.getElementById('user-role-display').textContent = user.role;
        renderSidebar();
        handleRouting();
        document.querySelectorAll('.role-btn').forEach(btn => {
             btn.classList.remove('bg-black', 'text-white');
             if(btn.dataset.role === state.currentUserRole) btn.classList.add('bg-black', 'text-white');
        });
    }

    document.getElementById('role-switcher').addEventListener('click', (e) => { if (e.target.closest('.role-btn')) { state.currentUserRole = e.target.closest('.role-btn').dataset.role; window.location.hash = '#dashboard'; updateUserUI(); } });
    document.getElementById('sidebar-nav-links').addEventListener('click', (e) => { const link = e.target.closest('a'); if (link) { e.preventDefault(); window.location.hash = link.getAttribute('href'); } });
    
    // Обработчик для кнопки чата в топ-баре
    const assistantChatBtn = document.getElementById('assistant-chat-btn');
    if (assistantChatBtn) {
        assistantChatBtn.addEventListener('click', function() {
            window.location.hash = '#my-assistant';
        });
    }
    
    document.getElementById('page-content-wrapper').addEventListener('click', e => {
        const link = e.target.closest('a');
        if (link && link.getAttribute('href')?.startsWith('#')) { e.preventDefault(); window.location.hash = link.getAttribute('href'); }
        
        if (e.target.closest('.focus-tab')) {
            const tabButton = e.target.closest('.focus-tab');
            document.querySelectorAll('.focus-tab').forEach(t => t.classList.remove('tab-active', 'text-muted-foreground'));
            tabButton.classList.add('tab-active'); tabButton.classList.remove('text-muted-foreground');
            document.querySelectorAll('.focus-tab-content').forEach(c => c.classList.add('page-hidden'));
            document.getElementById(`tab-${tabButton.dataset.tab}`).classList.remove('page-hidden');
        }
        
        if (e.target.closest('.approval-item')) {
            const offerId = e.target.closest('.approval-item').dataset.offerId;
            showModal('Review Offer for Elon Musk', `<div class="bg-muted p-4 rounded-md"><h4 class="font-semibold">Mini-Landing Page Preview</h4><p class="text-sm text-muted-foreground">This is a simulation of the offer page that will be sent.</p><img src="https://picsum.photos/seed/offer${offerId}/800/450" class="mt-4 rounded-md w-full"></div><div class="mt-6 flex justify-end gap-3"><button class="px-4 py-2 text-sm font-medium border rounded-md" onclick="document.getElementById('modal-container').dataset.state = 'closed'">Reject</button><button class="px-4 py-2 text-sm font-medium bg-black text-white rounded-md" onclick="document.getElementById('modal-container').dataset.state = 'closed'">Approve & Send</button></div>`);
        }
        
        if (e.target.id === 'generate-forecast-btn') {
            showModal('Q4 Revenue Forecast', `<div class="text-center"><p class="text-sm text-muted-foreground">Generated by Leonardo</p><p class="text-5xl font-bold my-4">$2.5M - $2.8M</p><p class="text-sm">Based on the current pipeline and a <span class="font-semibold">85% confidence interval</span>.</p></div>`);
        }

        if (e.target.closest('details summary')) {
            const details = e.target.closest('details');
            const icon = details.querySelector('summary svg');
            // Timeout to allow the 'open' attribute to update
            setTimeout(() => {
                if (details.open) {
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    icon.style.transform = 'rotate(-90deg)';
                }
            }, 0);
        }
        
        const distributeForm = e.target.closest('#distribute-form');
        if (distributeForm) {
            e.preventDefault();
            const countInput = document.getElementById('distribute-count');
            const count = parseInt(countInput.value);
            if (count > 0 && count <= state.unassignedLeads) {
                state.unassignedLeads -= count;
                alert(`${count} leads have been randomly distributed to agents and are now being processed by their AI assistants.`);
                renderImportsPage();
            } else {
                alert('Please enter a valid number of leads to distribute.');
            }
        }
    });

    // Функция рендеринга страницы лидов
    function renderLeadsPage() {
        const page = document.getElementById('page-leads');
        page.innerHTML = `
            <div class="space-y-6">
                <!-- Верхняя панель управления -->
                <div id="contacts-header-panel" class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <!-- Блок импорта и действий -->
                        <div id="contacts-actions" class="flex flex-col sm:flex-row gap-2">
                            <!-- Скрытый input для файлов -->
                            <input type="file" id="import-file-input" accept=".csv,.xlsx,.xls" class="hidden" multiple>
                        </div>
                    </div>
                </div>

                <!-- Основная таблица контактов -->
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                            <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                                <h3 class="font-semibold text-lg text-gray-900">Лиды</h3>
                                <!-- Табы фильтрации -->
                                <div id="contacts-filter-tabs" class="flex flex-wrap gap-2">
                                </div>
                            </div>
                            <div id="contacts-search-panel" class="flex items-center gap-3">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Мобильная версия (карточки) -->
                    <div id="contacts-mobile" class="block lg:hidden">
                        <div id="contacts-cards-container"></div>
                    </div>
                    
                    <!-- Десктопная версия (таблица) -->
                    <div id="contacts-desktop" class="block">
                        <div id="contacts-table-container"></div>
                    </div>
                </div>

                <!-- Групповые операции -->
                <div id="bulk-actions" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-6 shadow-sm">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <span class="text-sm font-medium text-blue-700">Выбрано контактов: <span id="selected-count">0</span></span>
                        <div class="flex gap-3">
                            <button id="bulk-message-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm font-medium transition-colors">
                                Отправить сообщение
                            </button>
                            <button id="bulk-export-btn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm font-medium transition-colors">
                                Экспорт
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Модальное окно добавления контакта -->
            <div id="add-contact-modal-container"></div>

            <!-- Модальное окно карточки контакта -->
            <div id="contact-view-modal-container"></div>

            <!-- Модальное окно массовой рассылки -->
            <div id="bulk-message-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-xl">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-semibold text-gray-900">Массовая рассылка</h2>
                            <button id="close-bulk-message-modal" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-9 px-3 text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Получатели: <span id="recipients-count">0</span> контактов</label>
                                <div id="recipients-list" class="max-h-32 overflow-y-auto bg-gray-50 rounded-lg p-3 text-sm border border-gray-200"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Тип сообщения</label>
                                <select id="message-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="email">Email</option>
                                    <option value="sms">SMS</option>
                                    <option value="whatsapp">WhatsApp</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Шаблон сообщения</label>
                                <select id="message-template" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="custom">Пользовательское</option>
                                    <option value="follow-up">Повторный контакт</option>
                                    <option value="offer">Предложение</option>
                                    <option value="newsletter">Новости</option>
                                </select>
                                <textarea id="message-content" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Введите текст сообщения..."></textarea>
                            </div>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-center gap-3 mb-2">
                                    <input type="checkbox" id="ai-personalization" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="ai-personalization" class="text-sm font-medium text-gray-900">Использовать AI-персонализацию</label>
                                </div>
                                <p class="text-xs text-blue-600">AI адаптирует сообщение под каждого получателя на основе истории взаимодействий</p>
                            </div>
                            
                            <div class="flex justify-end gap-3 pt-4">
                                <button id="preview-messages" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-3">Предпросмотр</button>
                            <button id="send-bulk-messages" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-blue-600 text-white hover:bg-blue-700 h-9 px-3">Отправить</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Модальное окно импорта контактов -->
            <div id="import-contacts-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-xl">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-semibold text-gray-900">Импорт контактов</h2>
                            <button id="close-import-modal" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-9 px-3 text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="space-y-6">
                            <!-- Загрузка файла -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Выберите файл для импорта</label>
                                <div id="file-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer">
                                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                    </svg>
                                    <p class="text-gray-600 mb-2">Перетащите файл сюда или нажмите для выбора</p>
                                    <p class="text-sm text-gray-500">Поддерживаются форматы: CSV, Excel (.xlsx, .xls)</p>
                                    <input type="file" id="import-file-hidden" accept=".csv,.xlsx,.xls" class="hidden" multiple>
                                </div>
                                <div id="selected-files" class="mt-3 space-y-2"></div>
                            </div>
                            
                            <!-- Настройки импорта -->
                            <div id="import-settings" class="hidden">
                                <h3 class="font-medium text-gray-900 mb-4">Настройки импорта</h3>
                                
                                <div class="space-y-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Источник контактов</label>
                                        <select id="import-source" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="website">Веб-сайт</option>
                                            <option value="social-media">Социальные сети</option>
                                            <option value="referral">Рекомендация</option>
                                            <option value="advertising">Реклама</option>
                                            <option value="cold-call">Холодный звонок</option>
                                            <option value="import">Импорт</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="skip-duplicates" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <span class="text-sm text-gray-700">Пропускать дубликаты (по email)</span>
                                        </label>
                                    </div>
                                    
                                    <div>
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="update-existing" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <span class="text-sm text-gray-700">Обновлять существующие контакты</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Предпросмотр данных -->
                            <div id="import-preview" class="hidden">
                                <h3 class="font-medium text-gray-900 mb-4">Предпросмотр данных</h3>
                                <div class="border border-gray-200 rounded-lg overflow-hidden">
                                    <div class="max-h-64 overflow-y-auto">
                                        <table class="w-full text-sm">
                                            <thead class="bg-gray-50 sticky top-0">
                                                <tr id="preview-headers"></tr>
                                            </thead>
                                            <tbody id="preview-data"></tbody>
                                        </table>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 mt-3">Показаны первые 5 записей из <span id="total-records">0</span></p>
                            </div>
                            
                            <!-- Результат импорта -->
                            <div id="import-result" class="hidden">
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <div class="flex items-center gap-2 mb-2">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span class="font-medium text-green-800">Импорт завершен</span>
                                    </div>
                                    <div class="text-sm text-green-700">
                                        <p>Добавлено: <span id="imported-count">0</span> контактов</p>
                                        <p>Пропущено дубликатов: <span id="skipped-count">0</span></p>
                                        <p>Обновлено: <span id="updated-count">0</span></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end gap-3 pt-6">
                                <button id="cancel-import" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-3">Отменить</button>
                            <button id="start-import" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-green-500 text-white hover:bg-green-600 hidden h-9 px-3">Начать импорт</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Инициализация функционала страницы лидов
        initializeLeadsPage();
    }

    // Инициализация функционала страницы лидов
    function initializeLeadsPage() {
        console.log('🚀 Initializing leads page...');
        console.log('📊 Initial leadsData check:', window.contactsData);
        
        let currentFilter = 'all';
        let currentSort = { field: null, direction: 'asc' };
        let selectedContacts = new Set();
        
        console.log('🎯 Initial filter set to:', currentFilter);
        
        // Рендеринг контактов
        function renderContacts() {
            console.log('🔍 renderContacts called');
            console.log('📊 contactsData:', window.contactsData);
            console.log('🎯 currentFilter:', currentFilter);
            
            // Проверяем, что данные контактов загружены
            if (!window.contactsData || !Array.isArray(window.contactsData)) {
                console.log('❌ Contacts data not loaded yet, retrying...');
                setTimeout(renderContacts, 100);
                return;
            }
            
            const filteredContacts = window.contactsData.filter(contact => {
                // Нормализуем статус для сравнения
                const normalizedStatus = contact.status.toLowerCase().replace(/\s+/g, '-');
                console.log(`🔄 Contact: ${contact.name}, Original status: "${contact.status}", Normalized: "${normalizedStatus}", Filter: "${currentFilter}"`);
                
                if (currentFilter !== 'all' && normalizedStatus !== currentFilter) {
                    console.log(`❌ Filtered out: ${contact.name} (status mismatch)`);
                    return false;
                }
                
                const searchTerm = document.getElementById('contacts-search')?.value.toLowerCase() || '';
                if (searchTerm && !contact.name.toLowerCase().includes(searchTerm) && 
                    !contact.email.toLowerCase().includes(searchTerm) && 
                    !contact.phone.includes(searchTerm)) {
                    console.log(`❌ Filtered out: ${contact.name} (search mismatch)`);
                    return false;
                }
                
                const sourceFilter = document.getElementById('source-filter')?.value || 'all';
                if (sourceFilter !== 'all' && contact.source !== sourceFilter) {
                    console.log(`❌ Filtered out: ${contact.name} (source mismatch)`);
                    return false;
                }
                
                console.log(`✅ Contact passed all filters: ${contact.name}`);
                return true;
            });
            
            console.log(`📋 Filtered contacts count: ${filteredContacts.length}`);
            console.log('📋 Filtered contacts:', filteredContacts.map(c => `${c.name} (${c.status})`));
            
            // Сортировка
            if (currentSort.field) {
                filteredContacts.sort((a, b) => {
                    let aVal = a[currentSort.field];
                    let bVal = b[currentSort.field];
                    
                    if (currentSort.field === 'lastContact') {
                        aVal = new Date(aVal);
                        bVal = new Date(bVal);
                    }
                    
                    if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            // Используем новые компоненты
            if (window.contactsTable) {
                window.contactsTable.render(filteredContacts);
            }
            if (window.contactsCards) {
                window.contactsCards.render(filteredContacts);
            }
        }
        
        // Старые функции рендеринга удалены - используются новые компоненты
        
        // Вспомогательные функции
        function formatPhone(phone) {
            const cleaned = phone.replace(/\D/g, '');
            if (cleaned.length === 11 && cleaned.startsWith('7')) {
                return `+7 ${cleaned.slice(1, 4)} ${cleaned.slice(4, 7)}-${cleaned.slice(7, 9)}-${cleaned.slice(9)}`;
            }
            return phone;
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'Вчера';
            if (diffDays < 7) return `${diffDays} дн. назад`;
            return date.toLocaleDateString('ru-RU');
        }
        
        function getSourceLabel(source) {
            const labels = {
                'website': 'Сайт',
                'referral': 'Рекомендация',
                'social': 'Соц. сети',
                'advertising': 'Реклама',
                'cold-call': 'Холодный звонок'
            };
            return labels[source] || source;
        }
        
        // Обработчики событий
        
        // Фильтрация по статусам
        document.querySelectorAll('.contact-filter-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                console.log('🎯 Filter tab clicked:', e.target.textContent, 'status:', e.target.dataset.status);
                
                document.querySelectorAll('.contact-filter-tab').forEach(t => {
                    t.classList.remove('bg-blue-500', 'text-white');
                    t.classList.add('bg-gray-100', 'text-gray-700');
                });
                e.target.classList.remove('bg-gray-100', 'text-gray-700');
                e.target.classList.add('bg-blue-500', 'text-white');
                
                currentFilter = e.target.dataset.status;
                console.log('🔄 Filter changed to:', currentFilter);
                renderContacts();
            });
        });
        
        // Поиск
        document.getElementById('contacts-search')?.addEventListener('input', renderContacts);
        document.getElementById('source-filter')?.addEventListener('change', renderContacts);
        
        // Сортировка
        document.querySelectorAll('[data-sort]').forEach(header => {
            header.addEventListener('click', (e) => {
                const field = e.target.dataset.sort;
                if (currentSort.field === field) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = field;
                    currentSort.direction = 'asc';
                }
                
                // Обновляем индикаторы сортировки
                document.querySelectorAll('.sort-indicator').forEach(indicator => {
                    indicator.textContent = '↕';
                });
                e.target.querySelector('.sort-indicator').textContent = currentSort.direction === 'asc' ? '↑' : '↓';
                
                renderContacts();
            });
        });
        
        // Выбор всех контактов
        document.getElementById('select-all-contacts')?.addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.contact-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
                const contactId = parseInt(checkbox.dataset.contactId);
                if (e.target.checked) {
                    selectedContacts.add(contactId);
                } else {
                    selectedContacts.delete(contactId);
                }
            });
            updateBulkActions();
        });
        
        // Выбор отдельных контактов
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('contact-checkbox')) {
                const contactId = parseInt(e.target.dataset.contactId);
                if (e.target.checked) {
                    selectedContacts.add(contactId);
                } else {
                    selectedContacts.delete(contactId);
                }
                updateBulkActions();
            }
        });
        
        // Обновление панели групповых операций
        function updateBulkActions() {
            const bulkActions = document.getElementById('bulk-actions');
            const selectedCount = document.getElementById('selected-count');
            
            if (selectedContacts.size > 0) {
                bulkActions?.classList.remove('hidden');
                if (selectedCount) selectedCount.textContent = selectedContacts.size;
            } else {
                bulkActions?.classList.add('hidden');
            }
        }
        
        // Модальные окна
        document.getElementById('add-contact-btn')?.addEventListener('click', () => {
            document.getElementById('add-contact-modal')?.classList.remove('hidden');
        });
        
        document.getElementById('close-add-contact-modal')?.addEventListener('click', () => {
            document.getElementById('add-contact-modal')?.classList.add('hidden');
        });
        
        document.getElementById('cancel-add-contact')?.addEventListener('click', () => {
            document.getElementById('add-contact-modal')?.classList.add('hidden');
        });
        
        // Импорт контактов
        document.getElementById('import-contacts-btn')?.addEventListener('click', () => {
            document.getElementById('import-contacts-modal')?.classList.remove('hidden');
        });
        
        document.getElementById('close-import-modal')?.addEventListener('click', () => {
            document.getElementById('import-contacts-modal')?.classList.add('hidden');
            resetImportModal();
        });
        
        document.getElementById('cancel-import')?.addEventListener('click', () => {
            document.getElementById('import-contacts-modal')?.classList.add('hidden');
            resetImportModal();
        });
        
        // Массовая отправка сообщений
        let currentSelectedContacts = new Set();
        
        // Обновляем локальную переменную при изменении выбора
        document.addEventListener('contacts-selection-changed', (e) => {
            console.log('🔄 contacts-selection-changed event received:', e.detail);
            currentSelectedContacts = new Set(e.detail.selectedContacts);
            console.log('📝 Updated currentSelectedContacts:', currentSelectedContacts);
        });
        
        document.getElementById('bulk-send-message-btn')?.addEventListener('click', () => {
            console.log('🖱️ bulk-send-message-btn clicked');
            console.log('📊 currentSelectedContacts size:', currentSelectedContacts.size);
            console.log('📋 currentSelectedContacts content:', Array.from(currentSelectedContacts));
            
            if (currentSelectedContacts.size === 0) {
                console.log('❌ No contacts selected, returning');
                return;
            }
            
            const selectedContactsList = Array.from(currentSelectedContacts).map(id => {
                const contact = window.contactsData.find(c => c.id === parseInt(id));
                console.log(`🔍 Looking for contact with id ${id}:`, contact);
                return contact ? contact.name : '';
            }).filter(Boolean);
            
            console.log('👥 Selected contacts list:', selectedContactsList);
            
            const modal = document.getElementById('bulk-message-modal');
            console.log('🪟 Modal element found:', !!modal);
            
            document.getElementById('recipients-count').textContent = currentSelectedContacts.size;
            document.getElementById('recipients-list').innerHTML = selectedContactsList.join(', ');
            
            if (modal) {
                console.log('✅ Removing hidden class from modal');
                modal.classList.remove('hidden');
                console.log('🎯 Modal classes after removal:', modal.className);
            } else {
                console.log('❌ Modal element not found!');
            }
        });
        
        document.getElementById('close-bulk-message-modal')?.addEventListener('click', () => {
            document.getElementById('bulk-message-modal')?.classList.add('hidden');
        });
        
        // Просмотр контакта
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('view-contact-btn')) {
                const contactId = parseInt(e.target.dataset.contactId);
                showContactCard(contactId);
            }
        });
        
        // Показ карточки контакта
        function showContactCard(contactId) {
            const contact = window.contactsData.find(c => c.id === contactId);
            if (!contact) return;
            
            // Используем новый компонент ContactViewModal
            if (window.contactViewModal) {
                window.contactViewModal.show(contact);
                return;
            }
            
            // Fallback для старого кода (не должен выполняться)
            const modal = document.getElementById('contact-card-modal');
            const content = document.getElementById('contact-card-content');
            
            if (!content) {
                console.error('Element contact-card-content not found');
                return;
            }
            
            content.innerHTML = `
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold">Карточка контакта</h2>
                        <button id="close-contact-card" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Основная информация -->
                        <div class="space-y-4">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-blue-500 text-white rounded-full flex items-center justify-center text-xl font-medium">
                                    ${contact.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold">${contact.name}</h3>
                                    <p class="text-gray-600">${contact.company || 'Не указано'}</p>
                                    <p class="text-sm text-gray-500">${contact.position || 'Не указано'}</p>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="flex items-center gap-3">
                                    <span class="text-gray-500">📞</span>
                                    <span>${formatPhone(contact.phone)}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-gray-500">✉️</span>
                                    <span>${contact.email}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-gray-500">🏷️</span>
                                    <span>${getSourceLabel(contact.source)}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-gray-500">📅</span>
                                    <span>Последний контакт: ${formatDate(contact.lastContact)}</span>
                                </div>
                            </div>
                            
                            <!-- Примечания -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Примечания</label>
                                <textarea class="w-full px-3 py-2 border rounded-lg" rows="4" placeholder="Добавить примечание...">${contact.notes || ''}</textarea>
                            </div>
                        </div>
                        
                        <!-- История взаимодействий -->
                        <div>
                            <h4 class="font-medium mb-3">История взаимодействий</h4>
                            <div class="space-y-3 max-h-64 overflow-y-auto">
                                ${contact.interactions ? contact.interactions.map(interaction => `
                                    <div class="border-l-2 border-blue-200 pl-3 pb-3">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-sm font-medium">${interaction.type}</span>
                                            <span class="text-xs text-gray-500">${formatDate(interaction.date)}</span>
                                        </div>
                                        <p class="text-sm text-gray-600">${interaction.description}</p>
                                    </div>
                                `).join('') : '<p class="text-sm text-gray-500">История взаимодействий пуста</p>'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Summary -->
                    ${contact.aiSummary ? `
                        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h4 class="font-medium mb-2 text-blue-800">🤖 AI Summary</h4>
                            <p class="text-sm text-blue-700">${contact.aiSummary}</p>
                        </div>
                    ` : ''}
                    
                    <!-- Панель инструментов -->
                    <div class="mt-6 flex flex-wrap gap-3 pt-4 border-t">
                        <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            ✏️ Редактировать
                        </button>
                        <button class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                            💬 Отправить сообщение
                        </button>
                        <button class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">
                            🤖 AI Квалификация
                        </button>
                        <button class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                            📝 Генерировать сообщение
                        </button>
                        <button class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                            📁 Архивировать
                        </button>
                        <button class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                            🗑️ Удалить
                        </button>
                    </div>
                </div>
            `;
            
            modal?.classList.remove('hidden');
            
            // Закрытие модального окна
            document.getElementById('close-contact-card')?.addEventListener('click', () => {
                modal?.classList.add('hidden');
            });
        }
        
        // Дублирующийся код удален - обработчики уже определены выше
        
        // Отправка формы добавления контакта
        document.getElementById('add-contact-form')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // Валидация
            const name = formData.get('name');
            const phone = formData.get('phone');
            const email = formData.get('email');
            
            if (!name || !phone || !email) {
                alert('Пожалуйста, заполните все обязательные поля');
                return;
            }
            
            // Валидация email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Пожалуйста, введите корректный email');
                return;
            }
            
            // Добавление нового контакта
            const newContact = {
                id: Math.max(...window.contactsData.map(c => c.id)) + 1,
                name: name,
                company: formData.get('company') || '',
                position: formData.get('position') || '',
                phone: phone,
                email: email,
                source: formData.get('source'),
                status: 'new',
                lastContact: new Date().toISOString(),
                notes: formData.get('notes') || '',
                interactions: [],
                aiSummary: null
            };
            
            window.contactsData.push(newContact);
            renderContacts();
            document.getElementById('add-contact-modal')?.classList.add('hidden');
            e.target.reset();
            
            // Показываем уведомление
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = '✅ Контакт успешно добавлен';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        });
        
        // Функции импорта контактов
        function resetImportModal() {
            document.getElementById('import-file-input').value = '';
            document.getElementById('import-preview').classList.add('hidden');
            document.getElementById('import-result').classList.add('hidden');
            document.getElementById('import-settings').classList.add('hidden');
            document.getElementById('import-step-1').classList.remove('hidden');
            document.getElementById('import-btn').disabled = true;
        }
        
        document.getElementById('import-file-input')?.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // Проверка типа файла
            const allowedTypes = ['text/csv', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(csv|xls|xlsx)$/i)) {
                alert('Поддерживаются только файлы CSV, XLS и XLSX');
                return;
            }
            
            // Показать настройки импорта
            document.getElementById('import-step-1').classList.add('hidden');
            document.getElementById('import-settings').classList.remove('hidden');
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-size').textContent = (file.size / 1024).toFixed(1) + ' KB';
            
            // Имитация парсинга файла
            setTimeout(() => {
                const sampleData = [
                    { name: 'Иван Петров', phone: '+7 999 123 45 67', email: 'ivan@example.com', company: 'ООО Пример' },
                    { name: 'Мария Сидорова', phone: '+7 999 234 56 78', email: 'maria@example.com', company: 'ИП Сидорова' },
                    { name: 'Алексей Козлов', phone: '+7 999 345 67 89', email: 'alex@example.com', company: 'Козлов и Партнеры' }
                ];
                
                document.getElementById('preview-data').innerHTML = sampleData.map(contact => `
                    <tr class="border-b">
                        <td class="px-4 py-2">${contact.name}</td>
                        <td class="px-4 py-2">${contact.phone}</td>
                        <td class="px-4 py-2">${contact.email}</td>
                        <td class="px-4 py-2">${contact.company}</td>
                    </tr>
                `).join('');
                
                document.getElementById('import-settings').classList.add('hidden');
                document.getElementById('import-preview').classList.remove('hidden');
                document.getElementById('import-btn').disabled = false;
            }, 1500);
        });
        
        document.getElementById('import-btn')?.addEventListener('click', () => {
            // Имитация импорта
            document.getElementById('import-preview').classList.add('hidden');
            document.getElementById('import-result').classList.remove('hidden');
            
            // Добавляем импортированные контакты
            const importedContacts = [
                {
                    id: Math.max(...window.contactsData.map(c => c.id)) + 1,
                    name: 'Иван Петров',
                    phone: '+7 999 123 45 67',
                    email: 'ivan@example.com',
                    company: 'ООО Пример',
                    position: '',
                    source: 'import',
                    status: 'new',
                    lastContact: new Date().toISOString(),
                    notes: 'Импортирован из файла',
                    interactions: [],
                    aiSummary: null
                },
                {
                    id: Math.max(...window.contactsData.map(c => c.id)) + 2,
                    name: 'Мария Сидорова',
                    phone: '+7 999 234 56 78',
                    email: 'maria@example.com',
                    company: 'ИП Сидорова',
                    position: '',
                    source: 'import',
                    status: 'new',
                    lastContact: new Date().toISOString(),
                    notes: 'Импортирован из файла',
                    interactions: [],
                    aiSummary: null
                },
                {
                    id: Math.max(...window.contactsData.map(c => c.id)) + 3,
                    name: 'Алексей Козлов',
                    phone: '+7 999 345 67 89',
                    email: 'alex@example.com',
                    company: 'Козлов и Партнеры',
                    position: '',
                    source: 'import',
                    status: 'new',
                    lastContact: new Date().toISOString(),
                    notes: 'Импортирован из файла',
                    interactions: [],
                    aiSummary: null
                }
            ];
            
            window.contactsData.push(...importedContacts);
            renderContacts();
            
            setTimeout(() => {
                document.getElementById('import-contacts-modal')?.classList.add('hidden');
                resetImportModal();
                
                // Показываем уведомление
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                notification.textContent = `✅ Импортировано ${importedContacts.length} контактов`;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 3000);
            }, 2000);
        });
        
        // Функция массовой отправки сообщений
        document.getElementById('send-bulk-message-btn')?.addEventListener('click', () => {
            const messageType = document.querySelector('input[name="message-type"]:checked')?.value;
            const template = document.getElementById('message-template').value;
            const customMessage = document.getElementById('custom-message').value;
            const useAI = document.getElementById('use-ai-personalization').checked;
            
            if (!messageType) {
                alert('Выберите тип сообщения');
                return;
            }
            
            if (messageType === 'template' && !template) {
                alert('Выберите шаблон сообщения');
                return;
            }
            
            if (messageType === 'custom' && !customMessage.trim()) {
                alert('Введите текст сообщения');
                return;
            }
            
            // Имитация отправки сообщений
            const selectedContactsList = Array.from(selectedContacts).map(id => {
                const contact = window.contactsData.find(c => c.id === id);
                return contact ? contact.name : '';
            }).filter(Boolean);
            
            document.getElementById('bulk-message-modal')?.classList.add('hidden');
            
            // Показываем уведомление об успешной отправке
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = `✅ Сообщения отправлены ${currentSelectedContacts.size} контактам`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
            
            // Очищаем выбранные контакты
            selectedContacts.clear();
            updateSelectedContactsUI();
        });
        
        // Инициализация
        renderContacts();
    }

    document.getElementById('mobile-menu-btn').addEventListener('click', () => { document.getElementById('sidebar').classList.toggle('hidden'); });
    window.addEventListener('hashchange', handleRouting);
    updateUserUI();
});
</script>

<!-- shadcn/ui Components -->
<script src="components/ui/button.js"></script>
<script src="components/ui/badge.js"></script>
<script src="components/ui/input.js"></script>
<script src="components/ui/select.js"></script>
<script src="components/ui/card.js"></script>
<script src="components/ui/table.js"></script>

<!-- Contacts Components -->
<script src="components/contacts/header-panel.js"></script>
<script src="components/contacts/contacts-table.js"></script>
<script src="components/add-contact-modal.js"></script>
<script src="components/contact-view-modal.js"></script>

<script>
// Инициализация компонентов лидов
document.addEventListener('DOMContentLoaded', () => {
    // Инициализируем верхнюю панель лидов при загрузке страницы лидов
    if (window.location.hash === '#leads' || window.location.hash === '') {
        initializeLeadsComponents();
    }

    // Инициализируем при переходе на страницу лидов
    window.addEventListener('hashchange', () => {
        if (window.location.hash === '#leads') {
            setTimeout(() => {
                initializeLeadsComponents();
            }, 100);
        }
    });
});

function initializeLeadsComponents() {
    // Проверяем, что мы на странице лидов и компоненты загружены
    if (document.getElementById('contacts-header-panel') && window.ContactsHeaderPanel) {
        // Инициализируем верхнюю панель лидов
        window.contactsHeaderPanel = new ContactsHeaderPanel();
    }
    
    // Инициализируем таблицу контактов для десктопа
    if (document.getElementById('contacts-table-container') && window.ContactsTable) {
        window.contactsTable = new ContactsTable();
    }
    
    // Инициализируем карточки контактов для мобильной версии
    if (document.getElementById('contacts-cards-container') && window.ContactsCards) {
        window.contactsCards = new ContactsCards();
        
        // Настраиваем колбэки
        window.contactsCards.setCallbacks({
            onContactSelect: (contactId, isSelected) => {
                if (isSelected) {
                    selectedContacts.add(contactId);
                } else {
                    selectedContacts.delete(contactId);
                }
            },
            onContactView: (contactId) => {
                viewContact(contactId);
            }
        });
    }
    
    // Инициализируем модальные окна
    if (window.AddContactModal) {
        window.addContactModal = new AddContactModal();
        window.addContactModal.init('add-contact-modal-container');
    }
    
    if (window.ContactViewModal) {
        window.contactViewModal = new ContactViewModal();
        window.contactViewModal.init('contact-view-modal-container');
    }
}

// Функция для открытия модального окна добавления контакта
function openAddContactModal() {
    if (window.addContactModal) {
        window.addContactModal.show();
    }
}

// Функция для просмотра контакта
function viewContact(contactId) {
    if (window.contactViewModal) {
        // Получаем данные контакта из localStorage или API
        const contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
        const contact = contacts.find(c => c.id === contactId);
        
        if (contact) {
            window.contactViewModal.show(contact);
        }
    }
}

// Обновляем обработчики кнопок
document.addEventListener('DOMContentLoaded', () => {
    // Обработчик для кнопки "Добавить" в верхней панели
    document.addEventListener('click', (e) => {
        if (e.target.closest('#add-contact-btn') || e.target.closest('[data-action="add-contact"]')) {
            e.preventDefault();
            openAddContactModal();
        }
    });
});

// Сохраняем старые функции для совместимости
function showAddContactModal() {
    openAddContactModal();
}

function hideAddContactModal() {
    if (window.addContactModal) {
        window.addContactModal.hide();
    }
}

function showContactCard(contactId) {
    viewContact(contactId);
}

function hideContactCard() {
    if (window.contactViewModal) {
        window.contactViewModal.hide();
    }
}
</script>

</body>
</html>